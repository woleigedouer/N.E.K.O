<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="live2d.manager">Live2D æ¨¡å‹ç®¡ç†å™¨ - Project N.E.K.O.</title>
    <!-- i18next åŠ è½½å™¨ï¼ˆç»Ÿä¸€å¤„ç† CDN åŠ è½½å’Œåˆå§‹åŒ–ï¼‰ -->
    <script src="/static/i18n-i18next.js"></script>
    <script src="/static/common_dialogs.js"></script>
    <style>
        *:focus {
            outline: none !important;
            box-shadow: none !important;
        }

        html,
        body {
            height: 100%;
            margin: 0;
            padding: 0;
            background: #eee;
            color: #222;
            font-family: 'Segoe UI', Arial, sans-serif;
            overflow: hidden;
        }

        #live2d-container {
            position: fixed;
            right: 0px;
            bottom: 0px;
            width: 100%;
            height: 100%;
            z-index: 10;
            pointer-events: auto;
        }

        #live2d-canvas {
            display: block;
            width: 100%;
            height: 100%;
            background: transparent;
            cursor: grab;
            pointer-events: auto;
        }

        #live2d-canvas:active {
            cursor: grabbing;
        }

        #sidebar {
            position: fixed;
            left: 20px;
            top: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            z-index: 20;
            width: 300px;
            max-width: calc(100vw - 40px);
            max-height: calc(100vh - 40px);
            padding: 20px;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            overflow-y: auto;
            overflow-x: hidden;
            box-sizing: border-box;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
            width: 100%;
            min-width: 0;
            box-sizing: border-box;
        }

        .control-label {
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }

        .control-select {
            padding: 10px 15px;
            border-radius: 8px;
            border: 1px solid #ddd;
            font-size: 14px;
            cursor: pointer;
            background: #fff;
            color: #333;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23d5f1ff' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            padding-right: 35px;
        }

        .btn {
            padding: 10px 15px;
            border-radius: 8px;
            border: none;
            font-size: 14px;
            cursor: pointer;
            color: white;
            transition: background 0.2s, transform 0.2s, box-shadow 0.2s;
            text-align: center;
            width: 100%;
            box-sizing: border-box;
            max-width: 100%;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        }

        .btn:disabled {
            background: #e0e0e0;
            cursor: not-allowed;
            opacity: 0.7;
        }

        .btn-primary {
            background: #44b7fe;
        }

        .btn-primary:hover:not(:disabled) {
            background: #2662c8;
        }

        .btn-secondary {
            background: #d5f1ff;
            color: #333;
        }

        .btn-secondary:hover:not(:disabled) {
            background: #b8e5ff;
            color: #333;
        }

        .btn-success {
            background: #44b7fe;
        }

        .btn-success:hover:not(:disabled) {
            background: #2662c8;
        }

        #save-position-btn {
            background: #d5f1ff !important;
            color: #333 !important;
        }

        #save-position-btn:hover:not(:disabled) {
            background: #b8e5ff !important;
            color: #333 !important;
        }

        .btn-icon {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .btn-icon img {
            width: 16px;
            height: 16px;
            object-fit: contain;
        }

        .action-group {
            display: flex;
            gap: 10px;
        }

        .action-group .control-select {
            flex-grow: 1;
        }

        #persistent-list {
            margin-top: 6px;
            max-height: 120px;
            overflow: auto;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 6px;
            background: #fff;
        }

        #status {
            margin-top: 10px;
            color: #4f8cff;
            font-size: 14px;
            font-weight: 500;
            max-width: 280px;
            word-break: break-all;
        }
    </style>
</head>

<body>

    <div id="sidebar">
        <div class="control-group">
            <button id="backToMainBtn" class="btn btn-primary" data-i18n="live2d.backToMain">â† è¿”å›ä¸»é¡µ</button>
        </div>

        <div class="control-group">
            <label class="control-label" data-i18n="live2d.importModel">å¯¼å…¥æ¨¡å‹:</label>
            <input type="file" id="model-upload" webkitdirectory directory multiple style="display: none;">
            <button id="upload-btn" class="btn btn-primary" data-i18n="live2d.selectFolder">ğŸ“ é€‰æ‹©æ–‡ä»¶å¤¹</button>
            <div id="upload-status" style="font-size:12px; color:#666; margin-top:4px;"></div>
        </div>

        <div class="control-group">
            <label for="model-select" class="control-label" data-i18n="live2d.selectModel">é€‰æ‹©æ¨¡å‹:</label>
            <select id="model-select" class="control-select">
                <option data-i18n="common.loading">åŠ è½½ä¸­...</option>
            </select>
        </div>

        <div class="control-group">
            <label class="control-label" data-i18n="live2d.motionPreview">åŠ¨ä½œé¢„è§ˆ:</label>
            <div class="action-group">
                <select id="motion-select" class="control-select" disabled>
                    <option data-i18n="live2d.pleaseLoadModel">è¯·å…ˆåŠ è½½æ¨¡å‹</option>
                </select>
                <button id="play-motion-btn" class="btn btn-primary btn-icon" disabled>
                    <img src="/static/icons/play_icon.png" alt="æ’­æ”¾" data-i18n-alt="live2d.play">
                    <span data-i18n="live2d.play">æ’­æ”¾</span>
                </button>
            </div>
        </div>

        <div class="control-group">
            <label class="control-label" data-i18n="live2d.expressionPreview">è¡¨æƒ…é¢„è§ˆ:</label>
            <div class="action-group">
                <select id="expression-select" class="control-select" disabled>
                    <option data-i18n="live2d.pleaseLoadModel">è¯·å…ˆåŠ è½½æ¨¡å‹</option>
                </select>
                <button id="play-expression-btn" class="btn btn-primary btn-icon" disabled>
                    <img src="/static/icons/play_icon.png" alt="æ’­æ”¾" data-i18n-alt="live2d.play">
                    <span data-i18n="live2d.play">æ’­æ”¾</span>
                </button>
            </div>
        </div>

        <div class="control-group">
            <label class="control-label" data-i18n="live2d.persistentExpression">å¸¸é©»è¡¨æƒ…ï¼ˆä»…expressionï¼‰:</label>
            <p style="font-size: 11px; color: #666; margin: 4px 0 8px 0;" data-i18n="live2d.persistentHint">
                å¸¸é©»è¡¨æƒ…ä¼šä¸€ç›´ç”Ÿæ•ˆï¼Œä¸ä¼šè¢«æ¸…é™¤æˆ–è¦†ç›–ï¼›æ­¤å¤„ä»…èƒ½é€‰æ‹© .exp3.jsonã€‚
            </p>
            <select id="persistent-expression-select" class="control-select" disabled>
                <option value="" data-i18n="live2d.selectPersistentExpression">é€‰æ‹©å¸¸é©»è¡¨æƒ…</option>
            </select>
            <div id="persistent-list" style="display: none;"></div>
        </div>

        <div class="control-group">
            <div style="display:flex; gap: 10px;">
                <button id="emotion-manager-btn" class="btn btn-primary btn-icon" disabled style="flex:1;">
                    <img src="/static/icons/emotion_config_icon.png" alt="æƒ…æ„Ÿé…ç½®" data-i18n-alt="live2d.emotionConfig">
                    <span data-i18n="live2d.emotionConfig">æƒ…æ„Ÿé…ç½®</span>
                </button>
                <button id="save-position-btn" class="btn btn-success btn-icon" disabled style="flex:1;">
                    <img src="/static/icons/save_settings.png" alt="ä¿å­˜è®¾ç½®" data-i18n-alt="live2d.saveSettings">
                    <span data-i18n="live2d.saveSettings">ä¿å­˜è®¾ç½®</span>
                </button>
            </div>
        </div>

        <div class="control-group">
            <a href="/live2d_parameter_editor" class="btn btn-secondary"
                style="width:100%; text-decoration: none; display: block; text-align: center;"
                data-i18n="live2d.parameterEditor.title">
                <span>ğŸ¨ å‚æ•°ç¼–è¾‘å™¨</span>
            </a>
        </div>


        <div id="status" data-i18n="status.initializing">æ­£åœ¨åˆå§‹åŒ–...</div>
    </div>

    <div id="live2d-container"><canvas id="live2d-canvas"></canvas></div>

    <script src="/static/libs/live2dcubismcore.min.js"></script>
    <script src="/static/libs/live2d.min.js"></script>
    <script src="/static/libs/pixi.min.js"></script>
    <script src="/static/libs/index.min.js"></script>
    <script src="/static/live2d-core.js"></script>
    <script src="/static/live2d-emotion.js"></script>
    <script src="/static/live2d-model.js"></script>
    <script src="/static/live2d-interaction.js"></script>
    <script src="/static/live2d-ui-buttons.js"></script>
    <script src="/static/live2d-ui-popup.js"></script>
    <script src="/static/live2d-ui-hud.js"></script>
    <script src="/static/live2d-ui-drag.js"></script>
    <script src="/static/live2d-init.js"></script>

    <script>
        // ç”¨äºé¡µé¢é—´é€šä¿¡çš„äº‹ä»¶å¤„ç†
        function sendMessageToMainPage(action) {
            try {
                // ä½¿ç”¨localStorageäº‹ä»¶æœºåˆ¶å‘é€æ¶ˆæ¯ç»™ä¸»é¡µé¢
                const message = {
                    action: action,
                    timestamp: Date.now()
                };
                localStorage.setItem('nekopage_message', JSON.stringify(message));
                localStorage.removeItem('nekopage_message'); // ç«‹å³ç§»é™¤ä»¥å…è®¸é‡å¤å‘é€ç›¸åŒæ¶ˆæ¯
            } catch (e) {
                console.log('å‘é€æ¶ˆæ¯ç»™ä¸»é¡µé¢å¤±è´¥:', e);
            }
        }

        // å…¨å±€å˜é‡ï¼šè·Ÿè¸ªæœªä¿å­˜çš„æ›´æ”¹
        window.hasUnsavedChanges = false;

        // å…¨å±æ§åˆ¶å‡½æ•°
        const requestFullscreen = () => {
            const elem = document.documentElement;
            if (elem.requestFullscreen) {
                return elem.requestFullscreen();
            } else if (elem.webkitRequestFullscreen) {
                return elem.webkitRequestFullscreen();
            } else if (elem.mozRequestFullScreen) {
                return elem.mozRequestFullScreen();
            } else if (elem.msRequestFullscreen) {
                return elem.msRequestFullscreen();
            }
            return Promise.reject(new Error('Fullscreen not supported'));
        };

        const exitFullscreen = () => {
            if (document.exitFullscreen) {
                return document.exitFullscreen();
            } else if (document.webkitExitFullscreen) {
                return document.webkitExitFullscreen();
            } else if (document.mozCancelFullScreen) {
                return document.mozCancelFullScreen();
            } else if (document.msExitFullscreen) {
                return document.msExitFullscreen();
            }
            return Promise.reject(new Error('Exit fullscreen not supported'));
        };

        const isFullscreen = () => {
            return !!(document.fullscreenElement ||
                document.webkitFullscreenElement ||
                document.mozFullScreenElement ||
                document.msFullscreenElement);
        };

        document.addEventListener('DOMContentLoaded', async () => {
            // Electronç™½å±ä¿®å¤
            if (document.body) {
                void document.body.offsetHeight;
                const currentOpacity = document.body.style.opacity || '1';
                document.body.style.opacity = '0.99';
                requestAnimationFrame(() => {
                    document.body.style.opacity = currentOpacity;
                });
            }

            const statusDiv = document.getElementById('status');
            const modelSelect = document.getElementById('model-select');
            const motionSelect = document.getElementById('motion-select');
            const expressionSelect = document.getElementById('expression-select');
            const playMotionBtn = document.getElementById('play-motion-btn');
            const playExpressionBtn = document.getElementById('play-expression-btn');
            const emotionManagerBtn = document.getElementById('emotion-manager-btn');
            const savePositionBtn = document.getElementById('save-position-btn');
            const uploadBtn = document.getElementById('upload-btn');
            const modelUpload = document.getElementById('model-upload');
            const uploadStatus = document.getElementById('upload-status');
            const backToMainBtn = document.getElementById('backToMainBtn');


            // æ£€æµ‹é¡µé¢æ¥æºï¼Œè®¾ç½®è¿”å›æŒ‰é’®æ–‡æœ¬
            const isPopupWindow = window.opener !== null;
            if (isPopupWindow) {
                backToMainBtn.textContent = t('common.close', 'âœ– å…³é—­');

                // å°è¯•æœ€å¤§åŒ–çª—å£
                try {
                    window.resizeTo(screen.availWidth, screen.availHeight);
                    window.moveTo(0, 0);
                } catch (e) {
                    console.log('æœ€å¤§åŒ–çª—å£å¤±è´¥:', e);
                }

                // ä¸ºpopupçª—å£æ·»åŠ å…¨å±æŒ‰é’®
                const fullscreenBtn = document.createElement('button');
                fullscreenBtn.id = 'fullscreen-btn';
                fullscreenBtn.className = 'btn btn-primary';
                fullscreenBtn.textContent = t('live2d.toggleFullscreen', 'åˆ‡æ¢å…¨å±');
                fullscreenBtn.setAttribute('data-i18n', 'live2d.toggleFullscreen');
                fullscreenBtn.onclick = async () => {
                    try {
                        if (isFullscreen()) {
                            await exitFullscreen();
                            fullscreenBtn.textContent = t('live2d.toggleFullscreen', 'åˆ‡æ¢å…¨å±');
                            fullscreenBtn.setAttribute('data-i18n', 'live2d.toggleFullscreen');
                        } else {
                            await requestFullscreen();
                            fullscreenBtn.textContent = t('live2d.exitFullscreen', 'é€€å‡ºå…¨å±');
                            fullscreenBtn.setAttribute('data-i18n', 'live2d.exitFullscreen');
                        }
                    } catch (e) {
                        console.log('åˆ‡æ¢å…¨å±å¤±è´¥:', e);
                    }
                };

                // å°†å…¨å±æŒ‰é’®æ·»åŠ åˆ°è¿”å›æŒ‰é’®æ—è¾¹
                const backToMainBtnParent = backToMainBtn.parentElement;
                backToMainBtnParent.appendChild(fullscreenBtn);
            } else {
                backToMainBtn.textContent = t('live2d.backToMain', 'â† è¿”å›ä¸»é¡µ');
            }

            // ç›‘å¬å…¨å±çŠ¶æ€å˜åŒ–ï¼Œæ›´æ–°æŒ‰é’®æ–‡æœ¬
            document.addEventListener('fullscreenchange', updateFullscreenButton);
            document.addEventListener('webkitfullscreenchange', updateFullscreenButton);
            document.addEventListener('mozfullscreenchange', updateFullscreenButton);
            document.addEventListener('MSFullscreenChange', updateFullscreenButton);

            function updateFullscreenButton() {
                const fullscreenBtn = document.getElementById('fullscreen-btn');
                if (fullscreenBtn) {
                    if (isFullscreen()) {
                        fullscreenBtn.textContent = t('live2d.exitFullscreen', 'é€€å‡ºå…¨å±');
                        fullscreenBtn.setAttribute('data-i18n', 'live2d.exitFullscreen');
                    } else {
                        fullscreenBtn.textContent = t('live2d.toggleFullscreen', 'åˆ‡æ¢å…¨å±');
                        fullscreenBtn.setAttribute('data-i18n', 'live2d.toggleFullscreen');
                    }
                }
            }

            // é¡µé¢åŠ è½½æ—¶å‘é€æ¶ˆæ¯éšè—ä¸»ç•Œé¢ï¼ˆä»…åœ¨å¼¹å‡ºçª—å£æ¨¡å¼ä¸‹ï¼‰
            if (isPopupWindow) {
                sendMessageToMainPage('hide_main_ui');
            }

            // ç¿»è¯‘è¾…åŠ©å‡½æ•°ï¼šç®€åŒ–ç¿»è¯‘è°ƒç”¨å¹¶å¤„ç†é”™è¯¯
            function t(key, fallback, params = {}) {
                try {
                    if (window.t && typeof window.t === 'function') {
                        return window.t(key, params);
                    }
                } catch (e) {
                    console.error(`[i18n] Translation failed for key "${key}":`, e);
                }
                return fallback;
            }

            let currentModelInfo = null;
            let availableModels = [];
            let currentModelFiles = { motion_files: [], expression_files: [] };
            let live2dModel = null;
            let currentEmotionMapping = null; // { motions: {...}, expressions: {...} }

            const showStatus = (msg, duration = 0) => {
                statusDiv.textContent = msg;
                if (duration > 0) {
                    setTimeout(() => {
                        if (currentModelInfo) {
                            showStatus(t('live2d.currentModel', `å½“å‰æ¨¡å‹: ${currentModelInfo.name}`, { model: currentModelInfo.name }));
                        }
                    }, duration);
                }
            };

            await window.live2dManager.initPIXI('live2d-canvas', 'live2d-container');
            showStatus(t('live2d.pixiInitialized', 'PIXI åˆå§‹åŒ–å®Œæˆ'));

            // å…ˆåŠ è½½æ¨¡å‹åˆ—è¡¨
            try {
                const response = await fetch('/api/live2d/models');
                availableModels = await response.json();
                if (availableModels.length > 0) {
                    modelSelect.innerHTML = `<option value="">${t('live2d.pleaseSelectModel', 'è¯·é€‰æ‹©ä¸€ä¸ªæ¨¡å‹')}</option>`;
                    availableModels.forEach(model => {
                        const option = document.createElement('option');
                        option.value = model.name;
                        // ä½¿ç”¨display_nameï¼ˆå¦‚æœå­˜åœ¨ï¼‰æ˜¾ç¤ºæ›´å‹å¥½çš„åç§°
                        option.textContent = model.display_name || model.name;
                        // ä½¿ç”¨dataå±æ€§å­˜å‚¨item_idï¼Œè¿™æ ·æ›´å®¹æ˜“åœ¨changeäº‹ä»¶ä¸­è·å–
                        option.dataset.itemId = model.item_id;
                        console.log('æ·»åŠ æ¨¡å‹é€‰é¡¹:', model.name, 'display_name:', model.display_name, 'item_id:', model.item_id);
                        modelSelect.appendChild(option);
                    });

                    showStatus(t('live2d.modelListLoaded', 'æ¨¡å‹åˆ—è¡¨åŠ è½½æˆåŠŸ'));
                } else {
                    showStatus(t('live2d.noModelsFound', 'æœªæ‰¾åˆ°å¯ç”¨æ¨¡å‹'));
                }
            } catch (e) {
                showStatus(t('live2d.modelListLoadFailed', 'åŠ è½½æ¨¡å‹åˆ—è¡¨å¤±è´¥'));
            }

            // ç„¶ååŠ è½½å½“å‰è§’è‰²çš„æ¨¡å‹ï¼ˆæ­¤æ—¶ä¸‹æ‹‰æ¡†å·²ç»æœ‰é€‰é¡¹äº†ï¼‰
            await loadCurrentCharacterModel();

            // å¦‚æœå·²è‡ªåŠ¨åŠ è½½äº†ä¸€ä¸ªæ¨¡å‹ï¼Œç¡®ä¿åœ¨ä¸‹æ‹‰æ¡†ä¸­é€‰ä¸­å®ƒ
            // è¿™æ˜¯åŒé‡ä¿é™©ï¼šé˜²æ­¢ loadCurrentCharacterModel() å†…éƒ¨è®¾ç½®å¤±è´¥
            if (currentModelInfo && currentModelInfo.name) {
                const exists = availableModels.some(m => m.name === currentModelInfo.name);
                if (exists && modelSelect.value !== currentModelInfo.name) {
                    console.log('ä¸‹æ‹‰æ¡†å€¼æœªæ­£ç¡®è®¾ç½®ï¼Œæ‰§è¡Œè¡¥æ•‘:', currentModelInfo.name);
                    modelSelect.value = currentModelInfo.name;
                }
            }

            // è·å– lanlan_name çš„è¾…åŠ©å‡½æ•°
            async function getLanlanName() {
                // ä¼˜å…ˆä» URL è·å–
                const urlParams = new URLSearchParams(window.location.search);
                let lanlanName = urlParams.get('lanlan_name') || '';

                // å¦‚æœ URL ä¸­æ²¡æœ‰ï¼Œä» API è·å–
                if (!lanlanName) {
                    try {
                        const response = await fetch('/api/config/page_config');
                        const data = await response.json();
                        if (data.success) {
                            lanlanName = data.lanlan_name || '';
                        }
                    } catch (error) {
                        console.error('è·å– lanlan_name å¤±è´¥:', error);
                    }
                }

                return lanlanName;
            }

            // åŠ¨æ€è®¾ç½®å‚æ•°ç¼–è¾‘å™¨é“¾æ¥ï¼Œä¼ é€’ lanlan_name å‚æ•°
            (async function updateParameterEditorLink() {
                try {
                    const paramEditorLink = document.querySelector('a[href="/live2d_parameter_editor"]');
                    if (paramEditorLink) {
                        const lanlanName = await getLanlanName();
                        if (lanlanName) {
                            paramEditorLink.href = `/live2d_parameter_editor?lanlan_name=${encodeURIComponent(lanlanName)}`;
                            console.log('å‚æ•°ç¼–è¾‘å™¨é“¾æ¥å·²æ›´æ–°ï¼Œè§’è‰²:', lanlanName);
                        }
                    }
                } catch (error) {
                    console.error('æ›´æ–°å‚æ•°ç¼–è¾‘å™¨é“¾æ¥å¤±è´¥:', error);
                }
            })();

            // ä¿å­˜æ¨¡å‹è®¾ç½®åˆ°è§’è‰²çš„å‡½æ•°
            async function saveModelToCharacter(modelName, itemId = null) {
                try {
                    // è·å–è§’è‰²åç§°
                    const lanlanName = await getLanlanName();

                    if (!lanlanName) {
                        showStatus(t('live2d.cannotSaveNoCharacter', 'æ— æ³•ä¿å­˜ï¼šæœªæŒ‡å®šè§’è‰²åç§°'));
                        return false;
                    }

                    // æ„å»ºä¿å­˜æ•°æ®ï¼ŒåŒ…å«æ¨¡å‹åç§°å’Œå¯é€‰çš„item_id
                    const saveData = {
                        live2d: modelName
                    };

                    // å¦‚æœæœ‰item_idï¼Œä¹Ÿä¿å­˜å®ƒ
                    if (itemId && itemId !== 'undefined') {
                        saveData.item_id = itemId;
                        console.log('ä¿å­˜æ¨¡å‹è®¾ç½®æ—¶åŒæ—¶ä¿å­˜item_id:', itemId);
                    }

                    const response = await fetch(`/api/characters/catgirl/l2d/${encodeURIComponent(lanlanName)}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(saveData)
                    });

                    const result = await response.json();

                    if (result.success) {
                        showStatus(t('live2d.modelSettingsSaved', `å·²ä¿å­˜æ¨¡å‹è®¾ç½®: ${lanlanName} -> ${modelName}`, { name: lanlanName, model: modelName }), 2000);
                        return true;
                    } else {
                        showStatus(t('live2d.saveFailed', `ä¿å­˜å¤±è´¥: ${result.error}`, { error: result.error }), 3000);
                        return false;
                    }
                } catch (error) {
                    console.error('ä¿å­˜æ¨¡å‹è®¾ç½®å¤±è´¥:', error);
                    showStatus(t('live2d.saveModelSettingsFailed', 'ä¿å­˜æ¨¡å‹è®¾ç½®å¤±è´¥'), 3000);
                    return false;
                }
            }

            // ä¿®æ”¹æ¨¡å‹é€‰æ‹©äº‹ä»¶ï¼Œè‡ªåŠ¨ä¿å­˜æ¨¡å‹è®¾ç½®
            modelSelect.addEventListener('change', async (e) => {
                const modelName = e.target.value;

                if (!modelName) return;

                currentModelInfo = availableModels.find(m => m.name === modelName);
                if (!currentModelInfo) return;

                // è·å–é€‰ä¸­çš„optionå…ƒç´ ï¼Œä»ä¸­è·å–item_id
                const selectedOption = e.target[e.target.selectedIndex];
                const modelSteamId = selectedOption ? selectedOption.dataset.itemId : currentModelInfo.item_id;
                
                // æ›´æ–°currentModelInfoçš„item_idï¼ˆå¦‚æœä»optionè·å–åˆ°äº†ï¼‰
                if (modelSteamId && modelSteamId !== 'undefined') {
                    currentModelInfo.item_id = modelSteamId;
                }

                await loadModel(modelName, currentModelInfo, modelSteamId);

                // ä¸è‡ªåŠ¨ä¿å­˜æ¨¡å‹åˆ°è§’è‰²ï¼Œæ”¹ä¸ºæ ‡è®°ä¸ºæœ‰æœªä¿å­˜æ›´æ”¹ï¼Œç”¨æˆ·éœ€æ‰‹åŠ¨ç‚¹å‡»â€œä¿å­˜è®¾ç½®â€
                window.hasUnsavedChanges = true;
                console.log('å·²æ ‡è®°ä¸ºæœªä¿å­˜æ›´æ”¹ï¼ˆæ¨¡å‹åˆ‡æ¢ï¼‰ï¼Œè¯·ç‚¹å‡» ä¿å­˜è®¾ç½® æŒä¹…åŒ–åˆ°è§’è‰²é…ç½®ã€‚');
            });

            // åŠ è½½æ¨¡å‹çš„å‡½æ•°
            async function loadModel(modelName, modelInfo, steam_id) {
                if (!modelName || !modelInfo) return;

                // ç¡®ä¿è·å–æ­£ç¡®çš„steam_idï¼Œä¼˜å…ˆä½¿ç”¨ä¼ å…¥çš„ï¼Œç„¶åä»modelInfoä¸­è·å–
                let finalSteamId = steam_id || modelInfo.item_id;
                console.log('modelInfo:', modelInfo);
                console.log('finalSteamId:', finalSteamId);
                showStatus(t('live2d.loadingModel', `æ­£åœ¨åŠ è½½æ¨¡å‹: ${modelName}...`, { model: modelName }));
                setControlsDisabled(true);

                try {
                    // 1. Fetch files list
                    let filesRes;
                    // æ ¹æ®modelInfoçš„sourceå­—æ®µå’ŒfinalSteamIdå†³å®šä½¿ç”¨å“ªä¸ªAPIç«¯ç‚¹
                    if (modelInfo.source === 'user_mods') {
                        // å¯¹äºç”¨æˆ·modæ¨¡å‹ï¼Œä½¿ç”¨modelNameæ„å»ºURL
                        console.log('Fetching model files for user mod:', modelName);
                        filesRes = await fetch(`/api/live2d/model_files/${encodeURIComponent(modelName)}`);
                    } else if (finalSteamId && finalSteamId !== 'undefined') {
                        // å¦‚æœæä¾›äº†finalSteamIdï¼Œè°ƒç”¨ä¸“é—¨çš„APIç«¯ç‚¹
                        filesRes = await fetch(`/api/live2d/model_files_by_id/${finalSteamId}`);
                    } else {
                        // å¦åˆ™ä½¿ç”¨åŸæ¥çš„APIç«¯ç‚¹
                        filesRes = await fetch(`/api/live2d/model_files/${encodeURIComponent(modelName)}`);
                    }
                    const filesData = await filesRes.json();
                    if (!filesData.success) throw new Error(t('live2d.modelFilesFetchFailed', 'æ— æ³•è·å–æ¨¡å‹æ–‡ä»¶åˆ—è¡¨'));
                    currentModelFiles = filesData;

                    // 2. Fetch model config
                    let modelJsonUrl;
                    // ä¼˜å…ˆä½¿ç”¨åç«¯è¿”å›çš„model_config_urlï¼ˆå¦‚æœæœ‰ï¼‰
                    if (filesData.model_config_url) {
                        modelJsonUrl = filesData.model_config_url;
                        console.log('ä½¿ç”¨åç«¯è¿”å›çš„æ¨¡å‹é…ç½®URL:', modelJsonUrl);
                    } else if (modelInfo.source === 'user_mods') {
                        // å¯¹äºç”¨æˆ·modæ¨¡å‹ï¼Œç›´æ¥ä½¿ç”¨modelInfo.pathï¼ˆå·²ç»åŒ…å«/user_mods/è·¯å¾„ï¼‰
                        modelJsonUrl = modelInfo.path;
                        console.log('ä½¿ç”¨ç”¨æˆ·modæ¨¡å‹è·¯å¾„:', modelJsonUrl);
                    } else if (finalSteamId && finalSteamId !== 'undefined') {
                        // å¦‚æœæä¾›äº†finalSteamIdä½†æ²¡æœ‰model_config_urlï¼Œä½¿ç”¨åŸæ¥çš„æ–¹å¼æ„å»ºURLï¼ˆå…¼å®¹æ¨¡å¼ï¼‰
                        modelJsonUrl = `/workshop/${finalSteamId}/${modelName}.model3.json`;
                        console.log('å…¼å®¹æ¨¡å¼ - æ„å»ºçš„æ¨¡å‹URL(å¸¦steam_id):', modelJsonUrl);
                    } else {
                        // å¦åˆ™ä½¿ç”¨åŸæ¥çš„è·¯å¾„
                        modelJsonUrl = modelInfo.path;
                        console.log('æ„å»ºçš„æ¨¡å‹URL(æœ¬åœ°):', modelJsonUrl);
                    }
                    const modelConfigRes = await fetch(modelJsonUrl);
                    if (!modelConfigRes.ok) throw new Error(t('live2d.modelConfigFetchFailed', `æ— æ³•è·å–æ¨¡å‹é…ç½®: ${modelConfigRes.statusText}`, { status: modelConfigRes.statusText }));
                    const modelConfig = await modelConfigRes.json();

                    // 3. Add URL context for the loader
                    modelConfig.url = modelJsonUrl;

                    // 4. Inject PreviewAll motion group AND ensure all expressions are referenced
                    if (!modelConfig.FileReferences) modelConfig.FileReferences = {};

                    // Motions
                    if (!modelConfig.FileReferences.Motions) modelConfig.FileReferences.Motions = {};
                    // åªæœ‰å½“æ¨¡å‹æœ‰åŠ¨ä½œæ–‡ä»¶æ—¶æ‰æ·»åŠ PreviewAllç»„
                    if (currentModelFiles.motion_files.length > 0) {
                        modelConfig.FileReferences.Motions.PreviewAll = currentModelFiles.motion_files.map(file => ({
                            File: file  // ç›´æ¥ä½¿ç”¨APIè¿”å›çš„å®Œæ•´è·¯å¾„
                        }));
                    }

                    // Expressions: Overwrite with all available expression files for preview purposes.
                    modelConfig.FileReferences.Expressions = currentModelFiles.expression_files.map(file => ({
                        Name: file.split('/').pop().replace('.exp3.json', ''),  // ä»è·¯å¾„ä¸­æå–æ–‡ä»¶åä½œä¸ºåç§°
                        File: file  // ç›´æ¥ä½¿ç”¨APIè¿”å›çš„å®Œæ•´è·¯å¾„
                    }));

                    // 5. Load preferences
                    const preferences = await window.live2dManager.loadUserPreferences();
                    console.log('åŠ è½½çš„åå¥½è®¾ç½®:', preferences);
                    console.log('å½“å‰æ¨¡å‹è·¯å¾„:', modelInfo.path);
                    const modelPreferences = preferences.find(p => p && p.model_path === modelInfo.path) || null;
                    console.log('åŒ¹é…çš„æ¨¡å‹åå¥½:', modelPreferences);

                    // 6. Load model FROM THE MODIFIED OBJECT
                    await window.live2dManager.loadModel(modelConfig, {
                        loadEmotionMapping: true,
                        dragEnabled: true,
                        wheelEnabled: true,
                        preferences: modelPreferences
                    });
                    live2dModel = window.live2dManager.getCurrentModel();

                    // æ·»åŠ æ¨¡å‹äº¤äº’ç›‘å¬å™¨ï¼Œè·Ÿè¸ªä½ç½®å’Œç¼©æ”¾å˜åŒ–
                    if (live2dModel && live2dModel.internalModel) {
                        const canvas = document.getElementById('live2d-canvas');
                        if (canvas) {
                            // ä½ç½®å’Œç¼©æ”¾çš„è‡ªåŠ¨ä¿å­˜ç°åœ¨ç”± live2d-interaction.js å¤„ç†
                        }
                    }

                    updateSelectWithOptions(motionSelect, currentModelFiles.motion_files, t('live2d.selectMotion', 'é€‰æ‹©åŠ¨ä½œ'), 'motion');
                    updateSelectWithOptions(expressionSelect, currentModelFiles.expression_files, t('live2d.selectExpression', 'é€‰æ‹©è¡¨æƒ…'), 'expression');

                    // æ›´æ–°å¸¸é©»è¡¨æƒ…é€‰æ‹©æ¡†ï¼ˆåªæ˜¾ç¤º .exp3.json æ–‡ä»¶ï¼‰
                    await updatePersistentExpressionSelect();

                    // 7. Load current emotion mapping for this model
                    await loadEmotionMappingForModel(modelName);

                    // åŠ è½½å¹¶æ˜¾ç¤ºå·²é…ç½®çš„å¸¸é©»è¡¨æƒ…
                    await loadPersistentExpressions();

                    // å¦‚æœæ²¡æœ‰åŠ¨ä½œæ–‡ä»¶ï¼Œç¦ç”¨åŠ¨ä½œç›¸å…³æ§ä»¶
                    if (currentModelFiles.motion_files.length === 0) {
                        motionSelect.disabled = true;
                        playMotionBtn.disabled = true;
                        motionSelect.innerHTML = `<option value="">${t('live2d.noMotionFiles', 'æ²¡æœ‰åŠ¨ä½œæ–‡ä»¶')}</option>`;
                    }
                    setControlsDisabled(false);
                    showStatus(t('live2d.modelLoadSuccess', `æ¨¡å‹ ${modelName} åŠ è½½æˆåŠŸ`, { model: modelName }));

                } catch (error) {
                    showStatus(t('live2d.modelLoadFailed', `åŠ è½½æ¨¡å‹ ${modelName} å¤±è´¥`, { model: modelName }));
                    console.error(error);
                    setControlsDisabled(false);
                }
            }

            playMotionBtn.addEventListener('click', () => {
                if (!live2dModel || !motionSelect.value) return;

                // æ£€æŸ¥æ˜¯å¦æœ‰åŠ¨ä½œæ–‡ä»¶
                if (currentModelFiles.motion_files.length === 0) {
                    showStatus(t('live2d.noMotionFilesStatus', 'æ²¡æœ‰åŠ¨ä½œæ–‡ä»¶'), 2000);
                    return;
                }

                const motionIndex = currentModelFiles.motion_files.indexOf(motionSelect.value);
                if (motionIndex > -1) {
                    try {
                        live2dModel.motion('PreviewAll', motionIndex, 3);
                        showStatus(t('live2d.playingMotion', `æ’­æ”¾åŠ¨ä½œ: ${motionSelect.value}`, { motion: motionSelect.value }), 1000);
                    } catch (error) {
                        console.error('æ’­æ”¾åŠ¨ä½œå¤±è´¥:', error);
                        showStatus(t('live2d.playMotionFailed', `æ’­æ”¾åŠ¨ä½œå¤±è´¥: ${motionSelect.value}`, { motion: motionSelect.value }), 2000);
                    }
                } else {
                    showStatus(t('live2d.motionFileNotExists', 'åŠ¨ä½œæ–‡ä»¶ä¸å­˜åœ¨'), 2000);
                }
            });

            playExpressionBtn.addEventListener('click', () => {
                if (!live2dModel || !expressionSelect.value) return;
                // ä»å®Œæ•´è·¯å¾„ä¸­æå–è¡¨æƒ…åç§°ï¼ˆå»æ‰è·¯å¾„å’Œæ‰©å±•åï¼‰
                const expressionName = expressionSelect.value.split('/').pop().replace('.exp3.json', '');
                console.log('æ’­æ”¾è¡¨æƒ…:', expressionName); // æ·»åŠ è°ƒè¯•ä¿¡æ¯
                try {
                    live2dModel.expression(expressionName);
                    showStatus(t('live2d.playingExpression', `æ’­æ”¾è¡¨æƒ…: ${expressionName}`, { expression: expressionName }), 1000);
                } catch (error) {
                    console.error('æ’­æ”¾è¡¨æƒ…å¤±è´¥:', error);
                    showStatus(t('live2d.playExpressionFailed', `æ’­æ”¾è¡¨æƒ…å¤±è´¥: ${expressionName}`, { expression: expressionName }), 2000);
                }
            });

            emotionManagerBtn.addEventListener('click', () => {
                if (!currentModelInfo) return;
                openModal('/live2d_emotion_manager');
            });

            savePositionBtn.addEventListener('click', async () => {
                if (!currentModelInfo || !live2dModel) return;
                showStatus(t('live2d.savingSettings', 'æ­£åœ¨ä¿å­˜è®¾ç½®...'));

                // æ·»åŠ è°ƒè¯•ä¿¡æ¯
                console.log('ä¿å­˜è®¾ç½® - æ¨¡å‹è·¯å¾„:', currentModelInfo.path);
                console.log('ä¿å­˜è®¾ç½® - å½“å‰ä½ç½®:', { x: live2dModel.x, y: live2dModel.y });
                console.log('ä¿å­˜è®¾ç½® - å½“å‰ç¼©æ”¾:', { x: live2dModel.scale.x, y: live2dModel.scale.y });

                // ä¿å­˜ä½ç½®å’Œç¼©æ”¾
                const positionSuccess = await window.live2dManager.saveUserPreferences(
                    currentModelInfo.path,
                    { x: live2dModel.x, y: live2dModel.y },
                    { x: live2dModel.scale.x, y: live2dModel.scale.y }
                );

                // ä¿å­˜æ¨¡å‹è®¾ç½®åˆ°è§’è‰²ï¼ŒåŒæ—¶ä¼ å…¥item_id
                const modelSuccess = await saveModelToCharacter(currentModelInfo.name, currentModelInfo.item_id);

                if (positionSuccess && modelSuccess) {
                    showStatus(t('live2d.settingsSaved', 'ä½ç½®å’Œæ¨¡å‹è®¾ç½®ä¿å­˜æˆåŠŸ!'), 2000);
                    window.hasUnsavedChanges = false; // ä¿å­˜æˆåŠŸåé‡ç½®æ ‡å¿—
                } else if (positionSuccess) {
                    showStatus(t('live2d.positionSavedModelFailed', 'ä½ç½®ä¿å­˜æˆåŠŸï¼Œæ¨¡å‹è®¾ç½®ä¿å­˜å¤±è´¥!'), 2000);
                } else if (modelSuccess) {
                    showStatus(t('live2d.modelSavedPositionFailed', 'æ¨¡å‹è®¾ç½®ä¿å­˜æˆåŠŸï¼Œä½ç½®ä¿å­˜å¤±è´¥!'), 2000);
                } else {
                    showStatus(t('live2d.saveFailedGeneral', 'ä¿å­˜å¤±è´¥!'), 2000);
                }
            });

            // è¿”å›ä¸»é¡µ/å…³é—­æŒ‰é’®
            backToMainBtn.addEventListener('click', async () => {
                // æ£€æŸ¥æ˜¯å¦æœ‰æœªä¿å­˜çš„æ›´æ”¹
                if (window.hasUnsavedChanges) {
                    const message = t('dialogs.unsavedChanges', 'æ‚¨æœ‰æœªä¿å­˜çš„è®¾ç½®ï¼Œç¡®å®šè¦ç¦»å¼€å—ï¼Ÿ');
                    const title = t('dialogs.confirmLeave', 'ç¡®è®¤ç¦»å¼€');
                    const confirmLeave = await showConfirm(message, title, { danger: true });
                    console.log('ç”¨æˆ·é€‰æ‹©:', confirmLeave ? 'ç¡®å®šç¦»å¼€' : 'å–æ¶ˆ');
                    if (!confirmLeave) {
                        return; // ç”¨æˆ·å–æ¶ˆï¼Œä¸ç¦»å¼€
                    }
                    // ç”¨æˆ·ç¡®è®¤ç¦»å¼€ï¼Œé‡ç½®æœªä¿å­˜çŠ¶æ€ï¼Œé¿å…è¢« beforeunload æ‹¦æˆª
                    window.hasUnsavedChanges = false;
                } else {
                    console.log('æ²¡æœ‰æœªä¿å­˜çš„æ›´æ”¹ï¼Œç›´æ¥è¿”å›');
                }

                // å¦‚æœå¤„äºå…¨å±çŠ¶æ€ï¼Œå…ˆé€€å‡ºå…¨å±
                if (isFullscreen()) {
                    try {
                        await exitFullscreen();
                        await new Promise(resolve => setTimeout(resolve, 100));
                    } catch (e) {
                        console.log('é€€å‡ºå…¨å±å¤±è´¥:', e);
                    }
                }

                // æ ¹æ®çª—å£ç±»å‹æ‰§è¡Œä¸åŒçš„æ“ä½œ
                if (isPopupWindow) {
                    // å¦‚æœæ˜¯å¼¹å‡ºçª—å£ï¼Œç›´æ¥å…³é—­
                    window.close();
                } else {
                    // å¦‚æœæ˜¯ä¸»çª—å£è·³è½¬ï¼Œç›´æ¥è·³è½¬å³å¯ï¼Œæ–°é¡µé¢ä¼šè‡ªåŠ¨åŠ è½½æœ€æ–°é…ç½®
                    window.location.href = '/';
                }
            });

            // ä¸Šä¼ æ¨¡å‹åŠŸèƒ½
            uploadBtn.addEventListener('click', () => {
                modelUpload.click();
            });

            modelUpload.addEventListener('change', async (e) => {
                const files = Array.from(e.target.files);
                if (files.length === 0) return;

                uploadStatus.textContent = t('live2d.uploadingModel', 'æ­£åœ¨ä¸Šä¼ æ¨¡å‹...');
                uploadStatus.style.color = '#4f8cff';
                uploadBtn.disabled = true;

                try {
                    const formData = new FormData();

                    // æ·»åŠ æ‰€æœ‰æ–‡ä»¶åˆ°FormData
                    for (const file of files) {
                        // ä¿ç•™æ–‡ä»¶çš„ç›¸å¯¹è·¯å¾„
                        formData.append('files', file, file.webkitRelativePath || file.name);
                    }

                    const response = await fetch('/api/live2d/upload_model', {
                        method: 'POST',
                        body: formData
                    });

                    const result = await response.json();

                    if (result.success) {
                        uploadStatus.textContent = t('live2d.uploadSuccess', `âœ“ ${result.message}`, { message: result.message });
                        uploadStatus.style.color = '#28a745';

                        // é‡æ–°åŠ è½½æ¨¡å‹åˆ—è¡¨
                        setTimeout(async () => {
                            try {
                                const modelsResponse = await fetch('/api/live2d/models');
                                availableModels = await modelsResponse.json();
                                modelSelect.innerHTML = `<option value="">${t('live2d.pleaseSelectModel', 'è¯·é€‰æ‹©ä¸€ä¸ªæ¨¡å‹')}</option>`;
                                availableModels.forEach(model => {
                                    const option = document.createElement('option');
                                    option.value = model.name;
                                    // ä½¿ç”¨display_nameï¼ˆå¦‚æœå­˜åœ¨ï¼‰æ˜¾ç¤ºæ›´å‹å¥½çš„åç§°
                                    option.textContent = model.display_name || model.name;
                                    modelSelect.appendChild(option);
                                });

                                // è‡ªåŠ¨é€‰æ‹©æ–°ä¸Šä¼ çš„æ¨¡å‹
                                if (result.model_name) {
                                    modelSelect.value = result.model_name;
                                    modelSelect.dispatchEvent(new Event('change'));
                                }

                                uploadStatus.textContent = '';
                            } catch (e) {
                                console.error('é‡æ–°åŠ è½½æ¨¡å‹åˆ—è¡¨å¤±è´¥:', e);
                            }
                        }, 1500);
                    } else {
                        uploadStatus.textContent = t('live2d.uploadFailed', `âœ— ${result.error}`, { error: result.error });
                        uploadStatus.style.color = '#dc3545';
                        setTimeout(() => {
                            uploadStatus.textContent = '';
                        }, 5000);
                    }
                } catch (error) {
                    console.error('ä¸Šä¼ å¤±è´¥:', error);
                    uploadStatus.textContent = t('live2d.uploadError', `âœ— ä¸Šä¼ å¤±è´¥: ${error.message}`, { error: error.message });
                    uploadStatus.style.color = '#dc3545';
                    setTimeout(() => {
                        uploadStatus.textContent = '';
                    }, 5000);
                } finally {
                    uploadBtn.disabled = false;
                    // é‡ç½®file inputä»¥å…è®¸é‡æ–°é€‰æ‹©åŒä¸€ä¸ªæ–‡ä»¶å¤¹
                    modelUpload.value = '';
                }
            });

            // æ›´æ–°å¸¸é©»è¡¨æƒ…é€‰æ‹©æ¡†
            async function updatePersistentExpressionSelect() {
                const persistentSelect = document.getElementById('persistent-expression-select');

                if (!currentModelFiles || !currentModelFiles.expression_files) {
                    persistentSelect.disabled = true;
                    return;
                }

                // åªæ˜¾ç¤º .exp3.json æ–‡ä»¶
                const exp3Files = currentModelFiles.expression_files.filter(file => file.endsWith('.exp3.json'));

                persistentSelect.innerHTML = `<option value="" data-i18n="live2d.selectPersistentExpression">${t('live2d.selectPersistentExpression', 'é€‰æ‹©å¸¸é©»è¡¨æƒ…')}</option>`;
                exp3Files.forEach(file => {
                    const option = document.createElement('option');
                    option.value = file;
                    const displayName = file.split('/').pop().replace('.exp3.json', '');
                    option.textContent = displayName;
                    persistentSelect.appendChild(option);
                });

                persistentSelect.disabled = false;
            }

            // åŠ è½½å·²é…ç½®çš„å¸¸é©»è¡¨æƒ…
            async function loadPersistentExpressions() {
                const persistentList = document.getElementById('persistent-list');
                if (!currentModelInfo) {
                    persistentList.style.display = 'none';
                    return;
                }

                try {
                    const res = await fetch(`/api/live2d/emotion_mapping/${encodeURIComponent(currentModelInfo.name)}`);
                    const data = await res.json();

                    if (data && data.success && data.config && data.config.expressions && data.config.expressions['å¸¸é©»']) {
                        const persistentExpressions = data.config.expressions['å¸¸é©»'];
                        if (persistentExpressions && persistentExpressions.length > 0) {
                            persistentList.innerHTML = '';
                            persistentExpressions.forEach(file => {
                                const item = document.createElement('div');
                                item.style.cssText = 'padding: 4px 8px; margin: 2px 0; background: #f0f0f0; border-radius: 4px; font-size: 12px; display: flex; justify-content: space-between; align-items: center;';
                                const fileName = file.split('/').pop().replace('.exp3.json', '');
                                const nameSpan = document.createElement('span');
                                nameSpan.textContent = fileName;
                                const deleteBtn = document.createElement('button');
                                deleteBtn.textContent = t('live2d.delete', 'åˆ é™¤');
                                deleteBtn.style.cssText = 'background: #dc3545; color: white; border: none; border-radius: 4px; padding: 2px 8px; cursor: pointer; font-size: 11px;';
                                deleteBtn.addEventListener('click', () => removePersistentExpression(file));
                                item.appendChild(nameSpan);
                                item.appendChild(deleteBtn);
                                persistentList.appendChild(item);
                            });
                            persistentList.style.display = 'block';
                        } else {
                            persistentList.style.display = 'none';
                        }
                    } else {
                        persistentList.style.display = 'none';
                    }
                } catch (e) {
                    console.error('åŠ è½½å¸¸é©»è¡¨æƒ…å¤±è´¥:', e);
                    persistentList.style.display = 'none';
                }
            }

            // æ·»åŠ å¸¸é©»è¡¨æƒ…
            const persistentSelect = document.getElementById('persistent-expression-select');
            persistentSelect.addEventListener('change', async () => {
                const selectedFile = persistentSelect.value;
                if (!selectedFile || !currentModelInfo) return;

                // é˜²æ­¢é‡å¤æ“ä½œ
                if (persistentSelect.disabled) return;
                persistentSelect.disabled = true;

                try {
                    // è·å–å½“å‰é…ç½®
                    const res = await fetch(`/api/live2d/emotion_mapping/${encodeURIComponent(currentModelInfo.name)}`);
                    const data = await res.json();

                    const currentConfig = data && data.success ? (data.config || { motions: {}, expressions: {} }) : { motions: {}, expressions: {} };

                    // ç¡®ä¿expressionså¯¹è±¡å­˜åœ¨
                    if (!currentConfig.expressions) {
                        currentConfig.expressions = {};
                    }

                    // ç¡®ä¿å¸¸é©»è¡¨æƒ…æ•°ç»„å­˜åœ¨
                    if (!currentConfig.expressions['å¸¸é©»']) {
                        currentConfig.expressions['å¸¸é©»'] = [];
                    }

                    // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
                    if (currentConfig.expressions['å¸¸é©»'].includes(selectedFile)) {
                        showStatus(t('live2d.persistentExpressionExists', 'è¯¥è¡¨æƒ…å·²æ·»åŠ ä¸ºå¸¸é©»è¡¨æƒ…'), 2000);
                        persistentSelect.value = '';
                        return; // æ³¨æ„ï¼šè¿™é‡Œreturnåä¼šåœ¨finallyä¸­æ¢å¤disabledçŠ¶æ€
                    }

                    // æ·»åŠ åˆ°å¸¸é©»è¡¨æƒ…åˆ—è¡¨
                    currentConfig.expressions['å¸¸é©»'].push(selectedFile);

                    // ä¿å­˜é…ç½®
                    const saveRes = await fetch(`/api/live2d/emotion_mapping/${encodeURIComponent(currentModelInfo.name)}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(currentConfig)
                    });

                    const saveData = await saveRes.json();
                    if (saveData.success) {
                        showStatus(t('live2d.persistentExpressionAdded', 'å¸¸é©»è¡¨æƒ…å·²æ·»åŠ '), 2000);
                        await loadPersistentExpressions();
                        persistentSelect.value = '';
                    } else {
                        showStatus(t('live2d.persistentExpressionAddFailed', 'æ·»åŠ å¸¸é©»è¡¨æƒ…å¤±è´¥'), 2000);
                        persistentSelect.value = '';
                    }
                } catch (e) {
                    console.error('æ·»åŠ å¸¸é©»è¡¨æƒ…å¤±è´¥:', e);
                    showStatus(t('live2d.persistentExpressionAddFailed', 'æ·»åŠ å¸¸é©»è¡¨æƒ…å¤±è´¥'), 2000);
                    persistentSelect.value = '';
                } finally {
                    persistentSelect.disabled = false;
                }
            });

            // åˆ é™¤å¸¸é©»è¡¨æƒ…
            window.removePersistentExpression = async function (file) {
                if (!currentModelInfo) return;

                try {
                    const res = await fetch(`/api/live2d/emotion_mapping/${encodeURIComponent(currentModelInfo.name)}`);
                    const data = await res.json();

                    const currentConfig = data && data.success ? (data.config || { motions: {}, expressions: {} }) : { motions: {}, expressions: {} };

                    if (currentConfig.expressions && currentConfig.expressions['å¸¸é©»']) {
                        const index = currentConfig.expressions['å¸¸é©»'].indexOf(file);
                        if (index > -1) {
                            currentConfig.expressions['å¸¸é©»'].splice(index, 1);

                            const saveRes = await fetch(`/api/live2d/emotion_mapping/${encodeURIComponent(currentModelInfo.name)}`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(currentConfig)
                            });

                            const saveData = await saveRes.json();
                            if (saveData.success) {
                                showStatus(t('live2d.persistentExpressionRemoved', 'å¸¸é©»è¡¨æƒ…å·²åˆ é™¤'), 2000);
                                await loadPersistentExpressions();
                            } else {
                                showStatus(t('live2d.persistentExpressionRemoveFailed', 'åˆ é™¤å¸¸é©»è¡¨æƒ…å¤±è´¥'), 2000);
                            }
                        }
                    }
                } catch (e) {
                    console.error('åˆ é™¤å¸¸é©»è¡¨æƒ…å¤±è´¥:', e);
                    showStatus(t('live2d.persistentExpressionRemoveFailed', 'åˆ é™¤å¸¸é©»è¡¨æƒ…å¤±è´¥'), 2000);
                }
            };

            // ä¿å­˜æŒ‰é’®å·²ç§»é™¤ï¼Œå› ä¸ºè¡¨æƒ…åœ¨æ·»åŠ /åˆ é™¤æ—¶å·²è‡ªåŠ¨ä¿å­˜

            // Helper functions
            function setControlsDisabled(disabled) {
                motionSelect.disabled = disabled;
                expressionSelect.disabled = disabled;
                playMotionBtn.disabled = disabled;
                playExpressionBtn.disabled = disabled;
                emotionManagerBtn.disabled = disabled;
                savePositionBtn.disabled = disabled;
                const persistentSelect = document.getElementById('persistent-expression-select');
                if (persistentSelect) persistentSelect.disabled = disabled;
            }

            function updateSelectWithOptions(select, options, defaultText, type) {
                select.innerHTML = `<option value="">${defaultText}</option>`;
                options.forEach(opt => {
                    const option = document.createElement('option');
                    option.value = opt;

                    if (type === 'expression') {
                        const displayName = opt.split('/').pop().replace('.exp3.json', '');
                        option.textContent = displayName;
                    } else if (type === 'motion') {
                        const displayName = opt.split('/').pop().replace('.motion3.json', '');
                        option.textContent = displayName;
                    } else {
                        option.textContent = opt;
                    }
                    select.appendChild(option);
                });
            }

            function openModal(url) {
                const modal = document.createElement('div');
                modal.style.cssText = `position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 10000; display: flex; justify-content: center; align-items: center;`;

                const iframeContainer = document.createElement('div');
                iframeContainer.style.cssText = `background: white; border-radius: 15px; width: 95%; height: 95%; max-width: 1500px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); display: flex; flex-direction: column; overflow: hidden;`;

                const header = document.createElement('div');
                header.style.cssText = `padding: 12px 20px; background: #f1f3f5; border-bottom: 1px solid #dee2e6; display: flex; justify-content: space-between; align-items: center;`;

                const title = document.createElement('h3');
                title.textContent = t('emotion.manager', 'æƒ…æ„Ÿé…ç½®ç®¡ç†å™¨');
                title.style.cssText = 'margin: 0;';

                const closeButton = document.createElement('button');
                closeButton.textContent = 'Ã—';
                closeButton.style.cssText = `background: none; border: none; font-size: 24px; cursor: pointer;`;

                const iframe = document.createElement('iframe');
                iframe.src = url;
                iframe.style.cssText = 'width: 100%; height: 100%; border: none;';

                const closeModal = () => {
                    modal.remove();
                    if (currentModelInfo) {
                        modelSelect.value = currentModelInfo.name;
                        modelSelect.dispatchEvent(new Event('change'));
                    }
                };

                closeButton.onclick = closeModal;
                header.appendChild(title);
                header.appendChild(closeButton);
                iframeContainer.appendChild(header);
                iframeContainer.appendChild(iframe);
                modal.appendChild(iframeContainer);
                document.body.appendChild(modal);
            }

            // ===== æƒ…ç»ªæ˜ å°„åŠ è½½ =====
            async function loadEmotionMappingForModel(modelName) {
                currentEmotionMapping = null;
                try {
                    const res = await fetch(`/api/live2d/emotion_mapping/${encodeURIComponent(modelName)}`);
                    const data = await res.json();
                    if (data && data.success && data.config) {
                        currentEmotionMapping = data.config;
                    } else {
                        currentEmotionMapping = { motions: {}, expressions: {} };
                    }
                } catch (e) {
                    currentEmotionMapping = { motions: {}, expressions: {} };
                }
            }

            // åŠ è½½å½“å‰è§’è‰²æ¨¡å‹çš„å‡½æ•°
            async function loadCurrentCharacterModel() {
                try {
                    // è·å–è§’è‰²åç§°
                    const lanlanName = await getLanlanName();

                    // æ„å»ºAPI URLï¼Œæ”¯æŒå¯é€‰çš„item_idå‚æ•°
                    let apiUrl = '/api/characters/current_live2d_model';
                    const params = new URLSearchParams();

                    if (lanlanName) {
                        params.append('catgirl_name', lanlanName);
                    }

                    // å¦‚æœæœ‰item_idï¼Œæ·»åŠ åˆ°å‚æ•°ä¸­
                    // æ³¨æ„ï¼šè¿™é‡Œçš„item_idéœ€è¦ä»é€‚å½“çš„åœ°æ–¹è·å–
                    // ä¾‹å¦‚ä»å…¨å±€å˜é‡ã€DOMå…ƒç´ æˆ–å…¶ä»–é€»è¾‘ä¸­è·å–
                    // è¿™é‡Œåªæ˜¯ç¤ºä¾‹ï¼Œå®é™…å®ç°å¯èƒ½éœ€è¦æ ¹æ®å…·ä½“æƒ…å†µè°ƒæ•´
                    const itemId = currentModelInfo ? currentModelInfo.item_id : null;
                    if (itemId) {
                        params.append('item_id', itemId);
                    }

                    // æ·»åŠ å‚æ•°åˆ°URL
                    const paramsString = params.toString();
                    if (paramsString) {
                        apiUrl += `?${paramsString}`;
                    }

                    const currentModelResponse = await fetch(apiUrl);
                    const currentModelData = await currentModelResponse.json();

                    if (!currentModelData.success) {
                        console.log('æ— æ³•è·å–å½“å‰è§’è‰²æ¨¡å‹ä¿¡æ¯:', currentModelData.error);
                        return;
                    }

                    const { catgirl_name, model_name, model_info } = currentModelData;

                    if (model_name && model_info) {
                        // å¦‚æœè§’è‰²æœ‰è®¾ç½®çš„æ¨¡å‹ï¼Œè‡ªåŠ¨åŠ è½½
                        console.log(`è‡ªåŠ¨åŠ è½½è§’è‰² ${catgirl_name} çš„æ¨¡å‹: ${model_name}`);
                        showStatus(t('live2d.loadingCharacterModel', `æ­£åœ¨åŠ è½½è§’è‰² ${catgirl_name} çš„æ¨¡å‹: ${model_name}...`, { name: catgirl_name, model: model_name }));

                        // è®¾ç½®æ¨¡å‹é€‰æ‹©å™¨
                        currentModelInfo = model_info;
                        modelSelect.value = model_name;

                        // åŠ è½½æ¨¡å‹
                        await loadModel(model_name, model_info, model_info.item_id);

                        showStatus(t('live2d.modelLoaded', `å·²åŠ è½½è§’è‰² ${catgirl_name} çš„æ¨¡å‹: ${model_name}`, { name: catgirl_name, model: model_name }));
                    } else {
                        // å¦‚æœè§’è‰²æ²¡æœ‰è®¾ç½®æ¨¡å‹ï¼Œæ˜¾ç¤ºæç¤ºä¿¡æ¯
                        console.log(`è§’è‰² ${catgirl_name} æœªè®¾ç½®Live2Dæ¨¡å‹`);
                        showStatus(t('live2d.modelNotSet', `è§’è‰² ${catgirl_name} æœªè®¾ç½®æ¨¡å‹ï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©`, { name: catgirl_name }));
                    }
                } catch (error) {
                    console.error('åŠ è½½å½“å‰è§’è‰²æ¨¡å‹å¤±è´¥:', error);
                    showStatus(t('live2d.loadCurrentModelFailed', 'åŠ è½½å½“å‰è§’è‰²æ¨¡å‹å¤±è´¥'));
                }
            }
        });

        // ç›‘å¬é¡µé¢å¸è½½äº‹ä»¶ï¼Œç¡®ä¿è¿”å›æ—¶ä¸»ç•Œé¢å¯è§
        window.addEventListener('beforeunload', (e) => {
            // å°è¯•é€€å‡ºå…¨å±
            if (isFullscreen()) {
                try {
                    exitFullscreen();
                } catch (err) {
                    console.log('é€€å‡ºå…¨å±å¤±è´¥:', err);
                }
            }

            if (window.opener) {
                sendMessageToMainPage('show_main_ui');
            }

            // å¦‚æœæœ‰æœªä¿å­˜çš„æ›´æ”¹ï¼Œæœ¬åº”é˜»æ­¢é¡µé¢å…³é—­å¹¶æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
            // ä½†åœ¨Electronä¸­å¯èƒ½å¯¼è‡´æ— æ³•å…³é—­çª—å£ï¼Œä¸”æ— æ³•ä½¿ç”¨è‡ªå®šä¹‰æ¨¡æ€çª—æ›¿ä»£ç³»ç»Ÿé»˜è®¤å¼¹çª—
            // å› æ­¤ç›´æ¥å…è®¸å…³é—­ï¼Œä¸å†æ‹¦æˆª
            /* 
            if (window.hasUnsavedChanges) {
                e.preventDefault();
                e.returnValue = ''; // Chromeéœ€è¦è¿™ä¸ª
                return ''; // æŸäº›æµè§ˆå™¨éœ€è¦è¿”å›å€¼
            }
            */
        });

        // ç¡®ä¿åœ¨é¡µé¢å…³é—­æ—¶ä¹Ÿæ¢å¤ä¸»ç•Œé¢
        window.addEventListener('unload', () => {
            // é¡µé¢å¸è½½æ—¶ä¸éœ€è¦å†æ¬¡å‘é€æ¶ˆæ¯
        });
    </script>

</body>

</html>